# C++编译原理

C++源码文件只有经过预编译、编译器以及链接器后才能生成可执行文件。

## 预编译

预编译是预编译器根据预编译指令格式化源文件。C++预编译器提供了一系列预编译指令，均以#开头，且预编译指令不区分大小写。主要完成文件包含、条件编译

### 预编译指令

* 条件编译：通过条件判断来选择是否编译区块源码，从而提高程序效率。

  * 一般形式的条件编译：当表达式逻辑为真时，编译第一段代码，否则编译第二段代码。

    ```c++
    #if <const experation>
      <code part one>
    #elif
      <code part two>
    #else
      <code part three>
    #endif
    ```
  
  * 宏名判断的条件编译：通过是否定义宏名来选择编译。

    ```c++
    // 如果定义宏名。
    #ifdef <宏名> // 等效于 #if define(<宏名>)。
    // 如果没有定义宏名。
    #ifndef <宏名> // 等效于 #if !define(<宏名>)。
    ```

    > Note：在条件编译时，必须存在endif来关闭if，else是可选项。

* 文件嵌入：通过include将其他源文件嵌入到当前文件中，文件一般以双引号或尖括号标识。

  ```c++
  // 嵌入iostream文件。
  #include <iostream>
  // 嵌入windows.h文件。
  #include <windows.h>
  // 嵌入user.h文件。
  #include "user.h"
  ```

  > Note：该指令可以嵌入任何文件，包括其他源文件，在嵌入式会将裸露的源码嵌到main()中；但是我们一般用来嵌入头文件。在使用尖括号时，预编译器只会指定的目录中寻找被包括的文件，在使用双引号时，预编译器首先到程序所在目录下寻找。

* 宏定义：通过define可以定义宏来使程序功能更加清晰。在宏定义时可以通过#与##来区别一些功能。

  ```c++
  // 不带参数的宏。
  #define PI 3.1415926
  // 带参数的宏。
  #define MIN(a,b) (a<b?a:b)
  // 取消宏定义。
  #undef PI
  ```

  在源码中，默认存在一些宏名：

  | 宏名 | 说明 |
  |:----:|:----- |
  | `__LINE__` | 当前编译行号 |
  | `__FILE__` | 编译的源文件名 |
  | `__DATE__` | 编译日期，格式：MM/DD/YY |
  | `__TIME__` | 编译时间，格式：HH:mm:ss |
  | `__cplusplus` | C++标准号 |

  > Note：宏只是一种使代码易于维护的机制，只会在使用宏的地方直接替换，而并不做任何运算。



* 终止编译：通过error来终止编译。

* 编译日志：通过line来生成日志。

  ```c++
  #line <line number> <message>
  ```

  ```c++
  #error <error message>
  ```

* 参数设置：通过pragma来设定一些编译的参数。

  ```c++
  // 指定源码只编译一次。
  #pragma once
  ```

* 预编译生成文件：通过使用-e参数来在编译时生成预编译后的文件。

  ```shell
  gcc -e <*.cpp> > <*.p>    # 生成预编译后的文件。
  ```


### 预编译的应用

* 通过预编译防止文件被多次包含，一般是指头文件被多次包含的问题。在解决这一问题时，可以使用条件编译或者编译器参数设置两种方式来实现。

  * 条件编译：

    ```c++
    // 例如在demo.h文件使用以下结构来实现。
    #ifndef _DEMO_H
    #define _DEMO_H
    // 在这里编辑需要编译的代码。
    #endif
    ```
  
  * 参数设定：

    ```c++
    // 在任何头文件中加添加以下语句到第一行。
    #pragma once
    ```
  
  通过这两种方式都可以解决文件的多次包含。条件编译是C/C++语言支持的，它不仅可以保证同一个文件不会被包含多次，也能保证内容完全相同的两个文件（或者代码片段）不会被不小心同时包含。并且需要打开文件之后才能判别是否被多次包含，这样会导致编译时间较长；但是可能会遇到宏名重复的风险，支持跨平台。而参数设置是受编译器影响的，可能会遇到编译器不支持的风险，并且这是针对本文件而言，并不是对所有相同文件；但是具有较高的编译速度，只针对文件，不支持跨平台。
 
## 编译器

即将预编译之后的源码文件转化为二进制文件。

## 链接器
